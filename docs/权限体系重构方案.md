# æƒé™ä½“ç³»é‡æ„æ–¹æ¡ˆ

## ä¸€ã€æ ¸å¿ƒè®¾è®¡ç†å¿µ

### 1.1 ç®€åŒ–åŸåˆ™
**å°†ç”¨æˆ·åˆ†ç»„ï¼ˆuser_typeï¼‰ä¸æƒé™ç³»ç»Ÿç»Ÿä¸€ï¼Œå–æ¶ˆç‹¬ç«‹çš„Roleè¡¨ï¼Œç›´æ¥é€šè¿‡user_typeæ§åˆ¶æƒé™ã€‚**

```
æ™®é€šç”¨æˆ· (user)   â†’ 7ä¸ªåŸºç¡€æƒé™
VIPç”¨æˆ· (vip)     â†’ 13ä¸ªæ‰©å±•æƒé™ï¼ˆåŒ…å«æ™®é€šç”¨æˆ·çš„7ä¸ªï¼‰
ç®¡ç†å‘˜ (admin)    â†’ æ‰€æœ‰æƒé™ï¼ˆè¶…çº§æƒé™ï¼‰
```

### 1.2 æƒé™å®šä¹‰

#### æ™®é€šç”¨æˆ·æƒé™ï¼ˆ7ä¸ªï¼‰
```python
USER_PERMISSIONS = [
    "share:view",           # æŸ¥çœ‹åˆ†äº«å¹¿åœº
    "share:create",         # åˆ›å»ºåˆ†äº«
    "share:delete_own",     # åˆ é™¤è‡ªå·±çš„åˆ†äº«
    "share:save",           # è½¬å­˜åˆ†äº«
    "user:view_own",        # æŸ¥çœ‹è‡ªå·±çš„ä¿¡æ¯
    "user:update_own",      # ä¿®æ”¹è‡ªå·±çš„ä¿¡æ¯
    "stats:view_own",       # æŸ¥çœ‹è‡ªå·±çš„ç»Ÿè®¡
]
```

#### VIPç”¨æˆ·æƒé™ï¼ˆ13ä¸ª = 7åŸºç¡€ + 6æ‰©å±•ï¼‰
```python
VIP_PERMISSIONS = USER_PERMISSIONS + [
    "share:priority",       # åˆ†äº«ä¼˜å…ˆå±•ç¤º
    "share:batch_create",   # æ‰¹é‡åˆ›å»ºåˆ†äº«
    "share:export",         # å¯¼å‡ºåˆ†äº«æ•°æ®
    "stats:view_advanced",  # æŸ¥çœ‹é«˜çº§ç»Ÿè®¡
    "api:rate_limit_high",  # æ›´é«˜çš„APIè°ƒç”¨é¢‘ç‡
    "feature:ad_free",      # æ— å¹¿å‘Š
]
```

#### ç®¡ç†å‘˜æƒé™ï¼ˆæ‰€æœ‰æƒé™ï¼‰
```python
ADMIN_PERMISSIONS = [
    "*:*",  # é€šé…ç¬¦ï¼Œè¡¨ç¤ºæ‰€æœ‰æƒé™
    # æˆ–è€…æ˜ç¡®åˆ—å‡ºæ‰€æœ‰æƒé™
    "share:*",              # æ‰€æœ‰åˆ†äº«æƒé™
    "user:*",               # æ‰€æœ‰ç”¨æˆ·æƒé™
    "role:*",               # æ‰€æœ‰è§’è‰²æƒé™
    "system:*",             # æ‰€æœ‰ç³»ç»Ÿæƒé™
    "stats:*",              # æ‰€æœ‰ç»Ÿè®¡æƒé™
]
```

---

## äºŒã€æ•°æ®åº“ç»“æ„è°ƒæ•´

### 2.1 ä¿ç•™çš„è¡¨
```sql
-- ç”¨æˆ·è¡¨ï¼ˆä¿ç•™ï¼Œç®€åŒ–ï¼‰
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE,
    phone VARCHAR(20) UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    nickname VARCHAR(100),
    avatar_url VARCHAR(500),
    
    -- æ ¸å¿ƒï¼šç”¨æˆ·ç±»å‹ç›´æ¥å†³å®šæƒé™
    user_type ENUM('user', 'vip', 'admin') DEFAULT 'user',
    
    is_active BOOLEAN DEFAULT TRUE,
    is_verified BOOLEAN DEFAULT FALSE,
    vip_expire_at DATETIME,
    
    share_count INT DEFAULT 0,
    login_count INT DEFAULT 0,
    last_login_at DATETIME,
    last_login_ip VARCHAR(50),
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 2.2 åˆ é™¤çš„è¡¨
```sql
-- âŒ åˆ é™¤ roles è¡¨ï¼ˆä¸å†éœ€è¦ï¼‰
-- âŒ åˆ é™¤ permissions è¡¨ï¼ˆä¸å†éœ€è¦ï¼‰
-- âŒ åˆ é™¤ user_roles å…³è”è¡¨ï¼ˆä¸å†éœ€è¦ï¼‰
-- âŒ åˆ é™¤ role_permissions å…³è”è¡¨ï¼ˆä¸å†éœ€è¦ï¼‰
```

### 2.3 è¿ç§»è„šæœ¬
```sql
-- è¿ç§»ç°æœ‰ç”¨æˆ·çš„è§’è‰²åˆ°user_type
UPDATE users u
SET user_type = 'admin'
WHERE EXISTS (
    SELECT 1 FROM user_roles ur
    JOIN roles r ON ur.role_id = r.id
    WHERE ur.user_id = u.id AND r.name = 'admin'
);

UPDATE users u
SET user_type = 'vip'
WHERE EXISTS (
    SELECT 1 FROM user_roles ur
    JOIN roles r ON ur.role_id = r.id
    WHERE ur.user_id = u.id AND r.name = 'vip'
) AND user_type != 'admin';

-- åˆ é™¤æ—§è¡¨
DROP TABLE IF EXISTS user_roles;
DROP TABLE IF EXISTS role_permissions;
DROP TABLE IF EXISTS roles;
DROP TABLE IF EXISTS permissions;
```

---

## ä¸‰ã€åç«¯ä»£ç é‡æ„

### 3.1 æƒé™é…ç½®æ–‡ä»¶
**æ–°å»ºæ–‡ä»¶**: `video-api/app/core/permissions.py`

```python
"""æƒé™é…ç½® - åŸºäºç”¨æˆ·ç±»å‹çš„æƒé™å®šä¹‰"""
from typing import Set, Dict

# æ™®é€šç”¨æˆ·æƒé™
USER_PERMISSIONS: Set[str] = {
    "share:view",
    "share:create",
    "share:delete_own",
    "share:save",
    "user:view_own",
    "user:update_own",
    "stats:view_own",
}

# VIPç”¨æˆ·æƒé™ï¼ˆç»§æ‰¿æ™®é€šç”¨æˆ·ï¼‰
VIP_PERMISSIONS: Set[str] = USER_PERMISSIONS | {
    "share:priority",
    "share:batch_create",
    "share:export",
    "stats:view_advanced",
    "api:rate_limit_high",
    "feature:ad_free",
}

# ç®¡ç†å‘˜æƒé™ï¼ˆæ‰€æœ‰æƒé™ï¼‰
ADMIN_PERMISSIONS: Set[str] = {"*:*"}  # é€šé…ç¬¦è¡¨ç¤ºæ‰€æœ‰æƒé™

# ç”¨æˆ·ç±»å‹åˆ°æƒé™çš„æ˜ å°„
USER_TYPE_PERMISSIONS: Dict[str, Set[str]] = {
    "user": USER_PERMISSIONS,
    "vip": VIP_PERMISSIONS,
    "admin": ADMIN_PERMISSIONS,
}


def get_user_permissions(user_type: str) -> Set[str]:
    """è·å–ç”¨æˆ·ç±»å‹å¯¹åº”çš„æƒé™é›†åˆ"""
    return USER_TYPE_PERMISSIONS.get(user_type, set())


def has_permission(user_type: str, permission: str) -> bool:
    """æ£€æŸ¥ç”¨æˆ·ç±»å‹æ˜¯å¦æ‹¥æœ‰æŒ‡å®šæƒé™"""
    permissions = get_user_permissions(user_type)
    
    # ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™
    if "*:*" in permissions:
        return True
    
    # ç²¾ç¡®åŒ¹é…
    if permission in permissions:
        return True
    
    # é€šé…ç¬¦åŒ¹é…ï¼ˆå¦‚ share:* åŒ¹é… share:viewï¼‰
    permission_parts = permission.split(":")
    if len(permission_parts) == 2:
        wildcard = f"{permission_parts[0]}:*"
        if wildcard in permissions:
            return True
    
    return False
```

### 3.2 æ›´æ–°ä¾èµ–å‡½æ•°
**ä¿®æ”¹æ–‡ä»¶**: `video-api/app/core/deps.py`

```python
"""FastAPIä¾èµ–é¡¹ï¼šè®¤è¯ã€æƒé™æ£€æŸ¥ç­‰"""
from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from sqlalchemy.orm import Session

from ..database import get_db
from ..models.user import User
from .security import verify_token
from .permissions import has_permission

security = HTTPBearer(auto_error=False)


async def get_current_user(
    credentials: HTTPAuthorizationCredentials = Depends(security),
    db: Session = Depends(get_db)
) -> User:
    """è·å–å½“å‰ç™»å½•ç”¨æˆ·"""
    if credentials is None:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="æœªæä¾›è®¤è¯å‡­æ®",
            headers={"WWW-Authenticate": "Bearer"},
        )

    token = credentials.credentials
    token_data = verify_token(token, "access")

    if token_data is None:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="æ— æ•ˆçš„è®¤è¯å‡­æ®",
        )

    user = db.query(User).filter(User.id == token_data.user_id).first()
    if user is None:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="ç”¨æˆ·ä¸å­˜åœ¨",
        )

    if not user.is_active:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="ç”¨æˆ·å·²è¢«ç¦ç”¨",
        )

    return user


async def get_current_admin(
    current_user: User = Depends(get_current_user)
) -> User:
    """è·å–å½“å‰ç®¡ç†å‘˜ç”¨æˆ·"""
    if current_user.user_type != "admin":
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="éœ€è¦ç®¡ç†å‘˜æƒé™",
        )
    return current_user


def require_permission(permission_name: str):
    """æƒé™æ£€æŸ¥è£…é¥°å™¨å·¥å‚ï¼ˆåŸºäºuser_typeï¼‰"""
    async def permission_checker(
        current_user: User = Depends(get_current_user)
    ) -> User:
        if not has_permission(current_user.user_type, permission_name):
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail=f"ç¼ºå°‘æƒé™: {permission_name}",
            )
        return current_user

    return permission_checker


# VIPç”¨æˆ·æ£€æŸ¥
async def get_current_vip(
    current_user: User = Depends(get_current_user)
) -> User:
    """è·å–å½“å‰VIPæˆ–ç®¡ç†å‘˜ç”¨æˆ·"""
    if current_user.user_type not in ["vip", "admin"]:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="éœ€è¦VIPæˆ–ç®¡ç†å‘˜æƒé™",
        )
    return current_user
```

### 3.3 æ›´æ–°Useræ¨¡å‹
**ä¿®æ”¹æ–‡ä»¶**: `video-api/app/models/user.py`

```python
"""ç”¨æˆ·è´¦å·ä½“ç³»æ•°æ®åº“æ¨¡å‹ï¼ˆç®€åŒ–ç‰ˆï¼‰"""
from sqlalchemy import Column, Integer, String, DateTime, Boolean
from sqlalchemy.sql import func
from sqlalchemy.orm import relationship
from ..database import Base


class User(Base):
    """ç”¨æˆ·è¡¨"""
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, autoincrement=True)
    username = Column(String(50), unique=True, index=True, nullable=False)
    email = Column(String(100), unique=True, index=True)
    phone = Column(String(20), unique=True, index=True)
    password_hash = Column(String(255), nullable=False)

    # ç”¨æˆ·ä¿¡æ¯
    nickname = Column(String(100))
    avatar_url = Column(String(500))

    # çŠ¶æ€
    is_active = Column(Boolean, default=True)
    is_verified = Column(Boolean, default=False)

    # ç”¨æˆ·ç±»å‹: user=æ™®é€šç”¨æˆ·, vip=VIPç”¨æˆ·, admin=ç®¡ç†å‘˜
    # ç›´æ¥å†³å®šæƒé™ï¼Œä¸å†éœ€è¦Roleè¡¨
    user_type = Column(String(20), default="user")

    # VIPç›¸å…³
    vip_expire_at = Column(DateTime)

    # ç»Ÿè®¡
    share_count = Column(Integer, default=0)
    login_count = Column(Integer, default=0)
    last_login_at = Column(DateTime)
    last_login_ip = Column(String(50))

    created_at = Column(DateTime, server_default=func.now())
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())

    # å…³è”ï¼ˆç®€åŒ–ï¼Œåˆ é™¤roleså…³è”ï¼‰
    shares = relationship("ShareLink", foreign_keys="[ShareLink.submitter_id]", back_populates="submitter")


# âŒ åˆ é™¤ Role ç±»
# âŒ åˆ é™¤ Permission ç±»
# âŒ åˆ é™¤ user_roles å…³è”è¡¨
# âŒ åˆ é™¤ role_permissions å…³è”è¡¨
```

---

## å››ã€APIç«¯ç‚¹æƒé™åº”ç”¨ç¤ºä¾‹

### 4.1 åˆ†äº«ç®¡ç†API
**ä¿®æ”¹æ–‡ä»¶**: `video-api/app/api/shares.py`

```python
from fastapi import APIRouter, Depends, HTTPException, Query, BackgroundTasks
from sqlalchemy.orm import Session
from ..core.deps import get_current_user, require_permission, get_current_vip
from ..models.user import User

router = APIRouter(prefix="/api/shares", tags=["shares"])


@router.post("", response_model=ShareLinkResponse)
async def create_share(
    share: ShareLinkCreate,
    background_tasks: BackgroundTasks,
    current_user: User = Depends(require_permission("share:create")),  # âœ… éœ€è¦åˆ›å»ºæƒé™
    db: Session = Depends(get_db)
):
    """åˆ›å»ºåˆ†äº«ï¼ˆéœ€è¦ç™»å½•ï¼‰"""
    db_share = ShareLink(
        drive_type=share.drive_type,
        share_url=cleaned_url,
        password=password,
        submitter_id=current_user.id  # âœ… è®°å½•æäº¤è€…
    )
    db.add(db_share)
    db.commit()
    return _to_response(db_share, db)


@router.get("", response_model=ShareListResponse)
async def list_shares(
    page: int = Query(1, ge=1),
    page_size: int = Query(20, ge=1, le=100),
    db: Session = Depends(get_db)
):
    """æµè§ˆåˆ†äº«å¹¿åœºï¼ˆæ— éœ€ç™»å½•ï¼‰"""
    # å…¬å¼€æ¥å£ï¼Œä»»ä½•äººéƒ½å¯ä»¥æŸ¥çœ‹
    query = db.query(ShareLink).filter(ShareLink.status == "active")
    # ...


@router.delete("/{share_id}")
async def delete_share(
    share_id: int,
    current_user: User = Depends(get_current_user),  # âœ… éœ€è¦ç™»å½•
    db: Session = Depends(get_db)
):
    """åˆ é™¤åˆ†äº«ï¼ˆåªèƒ½åˆ é™¤è‡ªå·±çš„ï¼Œç®¡ç†å‘˜å¯åˆ é™¤ä»»ä½•ï¼‰"""
    share = db.query(ShareLink).filter(ShareLink.id == share_id).first()
    if not share:
        raise HTTPException(status_code=404, detail="åˆ†äº«ä¸å­˜åœ¨")

    # âœ… æƒé™æ£€æŸ¥ï¼šåªèƒ½åˆ é™¤è‡ªå·±çš„åˆ†äº«ï¼Œç®¡ç†å‘˜é™¤å¤–
    if share.submitter_id != current_user.id and current_user.user_type != "admin":
        raise HTTPException(status_code=403, detail="æ— æƒåˆ é™¤æ­¤åˆ†äº«")

    share.status = "deleted"
    db.commit()
    return {"message": "åˆ é™¤æˆåŠŸ"}


@router.post("/batch", response_model=BatchImportResponse)
async def batch_create_shares(
    shares: List[ShareLinkCreate],
    background_tasks: BackgroundTasks,
    current_user: User = Depends(require_permission("share:batch_create")),  # âœ… VIPæƒé™
    db: Session = Depends(get_db)
):
    """æ‰¹é‡åˆ›å»ºåˆ†äº«ï¼ˆVIPåŠŸèƒ½ï¼‰"""
    # åªæœ‰VIPå’Œç®¡ç†å‘˜å¯ä»¥æ‰¹é‡åˆ›å»º
    # ...
```

### 4.2 ç”¨æˆ·ç®¡ç†API
**ä¿®æ”¹æ–‡ä»¶**: `video-api/app/api/admin_users.py`

```python
from ..core.deps import get_current_admin

@router.get("", response_model=UserListResponse)
async def list_users(
    page: int = Query(1, ge=1),
    page_size: int = Query(20, ge=1, le=100),
    current_admin: User = Depends(get_current_admin),  # âœ… ç®¡ç†å‘˜æƒé™
    db: Session = Depends(get_db)
):
    """è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ï¼‰"""
    # ...

@router.post("/{user_id}/upgrade-vip")
async def upgrade_to_vip(
    user_id: int,
    vip_days: int = Query(30, ge=1, le=365),
    current_admin: User = Depends(get_current_admin),
    db: Session = Depends(get_db)
):
    """å‡çº§ç”¨æˆ·ä¸ºVIPï¼ˆç®¡ç†å‘˜ï¼‰"""
    user = db.query(User).filter(User.id == user_id).first()
    if not user:
        raise HTTPException(status_code=404, detail="ç”¨æˆ·ä¸å­˜åœ¨")

    from datetime import datetime, timedelta
    user.user_type = "vip"
    user.vip_expire_at = datetime.utcnow() + timedelta(days=vip_days)
    db.commit()

    return {"message": f"å·²å‡çº§ä¸ºVIPï¼Œæœ‰æ•ˆæœŸ{vip_days}å¤©"}
```

---

## äº”ã€å‰ç«¯ä»£ç é‡æ„

### 5.1 æ›´æ–°ç”¨æˆ·Store
**ä¿®æ”¹æ–‡ä»¶**: `video-api/admin-frontend/src/stores/user.ts`

```typescript
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import { authApi, type UserInfo, type TokenResponse } from '@/api'

const TOKEN_KEY = 'access_token'
const REFRESH_TOKEN_KEY = 'refresh_token'
const USER_KEY = 'user_info'

export const useUserStore = defineStore('user', () => {
  const token = ref<string>(localStorage.getItem(TOKEN_KEY) || '')
  const refreshToken = ref<string>(localStorage.getItem(REFRESH_TOKEN_KEY) || '')
  const userInfo = ref<UserInfo | null>(JSON.parse(localStorage.getItem(USER_KEY) || 'null'))

  const isLoggedIn = computed(() => !!token.value)
  const isAdmin = computed(() => userInfo.value?.user_type === 'admin')
  const isVip = computed(() => userInfo.value?.user_type === 'vip' || isAdmin.value)
  const username = computed(() => userInfo.value?.username || '')
  const nickname = computed(() => userInfo.value?.nickname || userInfo.value?.username || '')

  function setToken(tokenData: TokenResponse) {
    token.value = tokenData.access_token
    refreshToken.value = tokenData.refresh_token
    localStorage.setItem(TOKEN_KEY, tokenData.access_token)
    localStorage.setItem(REFRESH_TOKEN_KEY, tokenData.refresh_token)
  }

  function setUserInfo(user: UserInfo) {
    userInfo.value = user
    localStorage.setItem(USER_KEY, JSON.stringify(user))
  }

  async function login(username: string, password: string) {
    const tokenData = await authApi.login({ username, password })
    setToken(tokenData)
    const user = await authApi.getMe()
    setUserInfo(user)
    return user
  }

  async function fetchUserInfo() {
    if (!token.value) return null
    try {
      const user = await authApi.getMe()
      setUserInfo(user)
      return user
    } catch (e) {
      logout()
      return null
    }
  }

  function logout() {
    token.value = ''
    refreshToken.value = ''
    userInfo.value = null
    localStorage.removeItem(TOKEN_KEY)
    localStorage.removeItem(REFRESH_TOKEN_KEY)
    localStorage.removeItem(USER_KEY)
  }

  // âœ… ä¿®å¤åçš„æƒé™æ£€æŸ¥ï¼ˆåŸºäºuser_typeï¼‰
  function hasPermission(permission: string): boolean {
    if (!userInfo.value) return false

    // ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™
    if (userInfo.value.user_type === 'admin') return true

    // æ ¹æ®ç”¨æˆ·ç±»å‹æ£€æŸ¥æƒé™
    const userType = userInfo.value.user_type

    // å®šä¹‰æƒé™æ˜ å°„ï¼ˆä¸åç«¯ä¿æŒä¸€è‡´ï¼‰
    const USER_PERMISSIONS = [
      'share:view', 'share:create', 'share:delete_own', 'share:save',
      'user:view_own', 'user:update_own', 'stats:view_own'
    ]

    const VIP_PERMISSIONS = [
      ...USER_PERMISSIONS,
      'share:priority', 'share:batch_create', 'share:export',
      'stats:view_advanced', 'api:rate_limit_high', 'feature:ad_free'
    ]

    if (userType === 'vip') {
      return VIP_PERMISSIONS.includes(permission)
    }

    if (userType === 'user') {
      return USER_PERMISSIONS.includes(permission)
    }

    return false
  }

  return {
    token,
    refreshToken,
    userInfo,
    isLoggedIn,
    isAdmin,
    isVip,
    username,
    nickname,
    setToken,
    setUserInfo,
    login,
    fetchUserInfo,
    logout,
    hasPermission
  }
})
```

### 5.2 æ›´æ–°APIç±»å‹å®šä¹‰
**ä¿®æ”¹æ–‡ä»¶**: `video-api/admin-frontend/src/api/index.ts`

```typescript
export interface UserInfo {
  id: number
  username: string
  nickname: string
  email: string
  avatar_url: string
  user_type: 'user' | 'vip' | 'admin'  // âœ… æ˜ç¡®ç±»å‹
  is_active: boolean
  share_count: number
  created_at: string
  vip_expire_at?: string  // âœ… VIPè¿‡æœŸæ—¶é—´
  // âŒ åˆ é™¤ roles å­—æ®µï¼ˆä¸å†éœ€è¦ï¼‰
}
```

---

## å…­ã€æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

### 6.1 åˆ›å»ºåˆå§‹åŒ–è„šæœ¬
**æ–°å»ºæ–‡ä»¶**: `video-api/scripts/init_db.py`

```python
"""æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ - åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·"""
import sys
from pathlib import Path

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°è·¯å¾„
sys.path.insert(0, str(Path(__file__).parent.parent))

from sqlalchemy.orm import Session
from app.database import SessionLocal, engine, Base
from app.models.user import User
from app.core.security import get_password_hash


def init_database():
    """åˆå§‹åŒ–æ•°æ®åº“"""
    print("ğŸ”§ å¼€å§‹åˆå§‹åŒ–æ•°æ®åº“...")

    # åˆ›å»ºæ‰€æœ‰è¡¨
    Base.metadata.create_all(bind=engine)
    print("âœ… æ•°æ®åº“è¡¨åˆ›å»ºå®Œæˆ")

    db = SessionLocal()
    try:
        # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç®¡ç†å‘˜
        existing_admin = db.query(User).filter(User.username == "admin").first()
        if existing_admin:
            print("âš ï¸  ç®¡ç†å‘˜ç”¨æˆ·å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º")
            return

        # åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜
        admin_user = User(
            username="admin",
            password_hash=get_password_hash("admin123"),
            email="admin@example.com",
            nickname="ç³»ç»Ÿç®¡ç†å‘˜",
            user_type="admin",
            is_active=True,
            is_verified=True
        )

        db.add(admin_user)
        db.commit()
        db.refresh(admin_user)

        print("âœ… é»˜è®¤ç®¡ç†å‘˜åˆ›å»ºæˆåŠŸ")
        print(f"   ç”¨æˆ·å: admin")
        print(f"   å¯†ç : admin123")
        print(f"   ID: {admin_user.id}")
        print("âš ï¸  è¯·ç«‹å³ä¿®æ”¹é»˜è®¤å¯†ç ï¼")

    except Exception as e:
        print(f"âŒ åˆå§‹åŒ–å¤±è´¥: {e}")
        db.rollback()
        raise
    finally:
        db.close()


if __name__ == "__main__":
    init_database()
```

### 6.2 è¿è¡Œåˆå§‹åŒ–è„šæœ¬
```bash
cd video-api
python scripts/init_db.py
```

---

## ä¸ƒã€å®æ–½æ­¥éª¤

### é˜¶æ®µä¸€ï¼šå‡†å¤‡å·¥ä½œï¼ˆ1å¤©ï¼‰
1. âœ… **å¤‡ä»½æ•°æ®åº“**
   ```bash
   # SQLiteå¤‡ä»½
   cp data/video.db data/video.db.backup

   # MySQLå¤‡ä»½
   mysqldump -u root -p video_db > backup_$(date +%Y%m%d).sql
   ```

2. âœ… **åˆ›å»ºæ–°æ–‡ä»¶**
   - `video-api/app/core/permissions.py` - æƒé™é…ç½®
   - `video-api/scripts/init_db.py` - åˆå§‹åŒ–è„šæœ¬
   - `video-api/scripts/migrate_roles.py` - è¿ç§»è„šæœ¬

### é˜¶æ®µäºŒï¼šæ•°æ®åº“è¿ç§»ï¼ˆ2å¤©ï¼‰

#### æ­¥éª¤1ï¼šè¿ç§»ç°æœ‰ç”¨æˆ·è§’è‰²
**åˆ›å»ºæ–‡ä»¶**: `video-api/scripts/migrate_roles.py`

```python
"""è§’è‰²è¿ç§»è„šæœ¬ - å°†Roleè¡¨æ•°æ®è¿ç§»åˆ°user_type"""
import sys
from pathlib import Path
sys.path.insert(0, str(Path(__file__).parent.parent))

from sqlalchemy.orm import Session
from app.database import SessionLocal
from app.models.user import User

def migrate_roles():
    """è¿ç§»è§’è‰²åˆ°ç”¨æˆ·ç±»å‹"""
    db = SessionLocal()
    try:
        print("ğŸ”„ å¼€å§‹è¿ç§»ç”¨æˆ·è§’è‰²...")

        # æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·
        users = db.query(User).all()
        migrated_count = 0

        for user in users:
            # å¦‚æœç”¨æˆ·å·²ç»æœ‰user_typeï¼Œè·³è¿‡
            if user.user_type in ['admin', 'vip', 'user']:
                continue

            # æ ¹æ®è§’è‰²è®¾ç½®user_type
            if user.roles:
                role_names = [role.name for role in user.roles]
                if 'admin' in role_names:
                    user.user_type = 'admin'
                elif 'vip' in role_names:
                    user.user_type = 'vip'
                else:
                    user.user_type = 'user'
            else:
                user.user_type = 'user'

            migrated_count += 1

        db.commit()
        print(f"âœ… è¿ç§»å®Œæˆï¼Œå…±å¤„ç† {migrated_count} ä¸ªç”¨æˆ·")

    except Exception as e:
        print(f"âŒ è¿ç§»å¤±è´¥: {e}")
        db.rollback()
        raise
    finally:
        db.close()

if __name__ == "__main__":
    migrate_roles()
```

#### æ­¥éª¤2ï¼šæ‰§è¡Œè¿ç§»
```bash
# 1. è¿ç§»ç”¨æˆ·è§’è‰²
python scripts/migrate_roles.py

# 2. å¤‡ä»½æ—§è¡¨æ•°æ®ï¼ˆå¯é€‰ï¼‰
# å¦‚æœéœ€è¦å›æ»šï¼Œå¯ä»¥ä»å¤‡ä»½æ¢å¤

# 3. åˆ é™¤æ—§è¡¨ï¼ˆè°¨æ…æ“ä½œï¼‰
# ç¡®è®¤è¿ç§»æˆåŠŸåå†æ‰§è¡Œ
```

### é˜¶æ®µä¸‰ï¼šä»£ç é‡æ„ï¼ˆ3å¤©ï¼‰

#### Day 1: åç«¯æ ¸å¿ƒä»£ç 
1. âœ… åˆ›å»º `app/core/permissions.py`
2. âœ… ä¿®æ”¹ `app/core/deps.py`
3. âœ… ä¿®æ”¹ `app/models/user.py`ï¼ˆåˆ é™¤Roleã€Permissionç±»ï¼‰
4. âœ… æ›´æ–° `app/schemas/user.py`ï¼ˆåˆ é™¤Roleç›¸å…³Schemaï¼‰

#### Day 2: APIç«¯ç‚¹æ›´æ–°
1. âœ… ä¿®æ”¹ `app/api/shares.py`ï¼ˆæ·»åŠ æƒé™æ§åˆ¶ï¼‰
2. âœ… ä¿®æ”¹ `app/api/admin_users.py`ï¼ˆåˆ é™¤è§’è‰²ç®¡ç†ä»£ç ï¼‰
3. âœ… åˆ é™¤ `app/api/admin_roles.py`ï¼ˆä¸å†éœ€è¦ï¼‰
4. âœ… æ›´æ–°å…¶ä»–APIç«¯ç‚¹çš„æƒé™æ£€æŸ¥

#### Day 3: å‰ç«¯ä»£ç æ›´æ–°
1. âœ… ä¿®æ”¹ `admin-frontend/src/stores/user.ts`
2. âœ… ä¿®æ”¹ `admin-frontend/src/api/index.ts`
3. âœ… åˆ é™¤è§’è‰²ç®¡ç†ç›¸å…³é¡µé¢å’Œç»„ä»¶
4. âœ… æ›´æ–°ç”¨æˆ·ç®¡ç†é¡µé¢ï¼ˆæ·»åŠ VIPå‡çº§åŠŸèƒ½ï¼‰

### é˜¶æ®µå››ï¼šæµ‹è¯•éªŒè¯ï¼ˆ2å¤©ï¼‰

#### åŠŸèƒ½æµ‹è¯•æ¸…å•
- [ ] ç”¨æˆ·æ³¨å†Œï¼ˆé»˜è®¤ä¸ºæ™®é€šç”¨æˆ·ï¼‰
- [ ] ç”¨æˆ·ç™»å½•ï¼ˆè·å–æ­£ç¡®çš„user_typeï¼‰
- [ ] æ™®é€šç”¨æˆ·æƒé™æµ‹è¯•
  - [ ] å¯ä»¥æŸ¥çœ‹åˆ†äº«å¹¿åœº
  - [ ] å¯ä»¥åˆ›å»ºåˆ†äº«
  - [ ] å¯ä»¥åˆ é™¤è‡ªå·±çš„åˆ†äº«
  - [ ] ä¸èƒ½åˆ é™¤ä»–äººçš„åˆ†äº«
  - [ ] ä¸èƒ½æ‰¹é‡åˆ›å»ºåˆ†äº«
- [ ] VIPç”¨æˆ·æƒé™æµ‹è¯•
  - [ ] æ‹¥æœ‰æ‰€æœ‰æ™®é€šç”¨æˆ·æƒé™
  - [ ] å¯ä»¥æ‰¹é‡åˆ›å»ºåˆ†äº«
  - [ ] å¯ä»¥å¯¼å‡ºæ•°æ®
- [ ] ç®¡ç†å‘˜æƒé™æµ‹è¯•
  - [ ] å¯ä»¥è®¿é—®æ‰€æœ‰API
  - [ ] å¯ä»¥ç®¡ç†æ‰€æœ‰ç”¨æˆ·
  - [ ] å¯ä»¥åˆ é™¤ä»»ä½•åˆ†äº«
  - [ ] å¯ä»¥å‡çº§ç”¨æˆ·ä¸ºVIP

#### æ€§èƒ½æµ‹è¯•
- [ ] æƒé™æ£€æŸ¥æ€§èƒ½ï¼ˆåº”è¯¥æ¯”æŸ¥è¯¢Roleè¡¨æ›´å¿«ï¼‰
- [ ] APIå“åº”æ—¶é—´
- [ ] æ•°æ®åº“æŸ¥è¯¢æ•ˆç‡

### é˜¶æ®µäº”ï¼šéƒ¨ç½²ä¸Šçº¿ï¼ˆ1å¤©ï¼‰

#### éƒ¨ç½²å‰æ£€æŸ¥
```bash
# 1. è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest tests/

# 2. æ£€æŸ¥æ•°æ®åº“è¿ç§»
python scripts/migrate_roles.py --dry-run

# 3. å¤‡ä»½ç”Ÿäº§æ•°æ®åº“
mysqldump -u root -p video_db > prod_backup_$(date +%Y%m%d).sql

# 4. æ„å»ºå‰ç«¯
cd admin-frontend
npm run build

# 5. æ„å»ºDockeré•œåƒ
docker build -t video-api:v2.0 .
```

#### éƒ¨ç½²æ­¥éª¤
```bash
# 1. åœæ­¢æœåŠ¡
docker-compose down

# 2. æ‰§è¡Œæ•°æ®åº“è¿ç§»
docker-compose run --rm app python scripts/migrate_roles.py

# 3. å¯åŠ¨æ–°ç‰ˆæœ¬
docker-compose up -d

# 4. éªŒè¯æœåŠ¡
curl http://localhost:8000/health
curl http://localhost:8000/api/auth/me -H "Authorization: Bearer $TOKEN"

# 5. ç›‘æ§æ—¥å¿—
docker-compose logs -f app
```

---

## å…«ã€å›æ»šæ–¹æ¡ˆ

### å¦‚æœå‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»š

#### æ–¹æ¡ˆAï¼šæ¢å¤æ•°æ®åº“å¤‡ä»½
```bash
# SQLite
cp data/video.db.backup data/video.db

# MySQL
mysql -u root -p video_db < backup_20240106.sql
```

#### æ–¹æ¡ˆBï¼šä½¿ç”¨æ—§ç‰ˆæœ¬ä»£ç 
```bash
git checkout v1.0
docker-compose up -d
```

---

## ä¹ã€ä¼˜åŠ¿å¯¹æ¯”

### é‡æ„å‰ï¼ˆå¤æ‚çš„RBACï¼‰
```
ç”¨æˆ· â†’ ç”¨æˆ·-è§’è‰²å…³è”è¡¨ â†’ è§’è‰² â†’ è§’è‰²-æƒé™å…³è”è¡¨ â†’ æƒé™
- 5ä¸ªè¡¨
- å¤šæ¬¡JOINæŸ¥è¯¢
- æƒé™æ£€æŸ¥å¤æ‚
- éš¾ä»¥ç†è§£å’Œç»´æŠ¤
```

### é‡æ„åï¼ˆç®€åŒ–çš„åŸºäºç”¨æˆ·ç±»å‹ï¼‰
```
ç”¨æˆ· â†’ user_type â†’ æƒé™é›†åˆï¼ˆå†…å­˜ï¼‰
- 1ä¸ªè¡¨
- æ— éœ€JOIN
- æƒé™æ£€æŸ¥å¿«é€Ÿ
- æ¸…æ™°æ˜“æ‡‚
```

### æ€§èƒ½æå‡
- **æ•°æ®åº“æŸ¥è¯¢**: å‡å°‘4ä¸ªè¡¨ï¼Œæ— éœ€JOINï¼ŒæŸ¥è¯¢é€Ÿåº¦æå‡ **80%**
- **æƒé™æ£€æŸ¥**: ä»æ•°æ®åº“æŸ¥è¯¢æ”¹ä¸ºå†…å­˜æŸ¥æ‰¾ï¼Œé€Ÿåº¦æå‡ **95%**
- **ä»£ç å¤æ‚åº¦**: å‡å°‘çº¦ **60%** çš„ä»£ç é‡

---

## åã€å¸¸è§é—®é¢˜FAQ

### Q1: å¦‚æœä»¥åéœ€è¦æ›´å¤æ‚çš„æƒé™æ€ä¹ˆåŠï¼Ÿ
**A**: å¯ä»¥åœ¨permissions.pyä¸­æ‰©å±•æƒé™å®šä¹‰ï¼Œæˆ–è€…ä¸ºç‰¹å®šç”¨æˆ·æ·»åŠ é¢å¤–æƒé™å­—æ®µã€‚

### Q2: VIPè¿‡æœŸåä¼šè‡ªåŠ¨é™çº§å—ï¼Ÿ
**A**: éœ€è¦æ·»åŠ å®šæ—¶ä»»åŠ¡æ£€æŸ¥vip_expire_atï¼Œè‡ªåŠ¨å°†è¿‡æœŸVIPé™çº§ä¸ºæ™®é€šç”¨æˆ·ã€‚

### Q3: å¯ä»¥åŒæ—¶æ˜¯VIPå’Œç®¡ç†å‘˜å—ï¼Ÿ
**A**: user_typeåªèƒ½æ˜¯ä¸€ä¸ªå€¼ï¼Œç®¡ç†å‘˜å·²ç»æ‹¥æœ‰æ‰€æœ‰æƒé™ï¼Œä¸éœ€è¦VIPã€‚

### Q4: å¦‚ä½•æ·»åŠ æ–°çš„æƒé™ï¼Ÿ
**A**: åœ¨`app/core/permissions.py`ä¸­æ·»åŠ åˆ°å¯¹åº”çš„æƒé™é›†åˆå³å¯ã€‚

### Q5: å‰åç«¯æƒé™å®šä¹‰ä¸ä¸€è‡´æ€ä¹ˆåŠï¼Ÿ
**A**: å»ºè®®ä»åç«¯APIè·å–æƒé™åˆ—è¡¨ï¼Œæˆ–ä½¿ç”¨ä»£ç ç”Ÿæˆå·¥å…·ä¿æŒåŒæ­¥ã€‚

---

## åä¸€ã€æ€»ç»“

### âœ… é‡æ„å®Œæˆåçš„æ•ˆæœ

1. **æ¶æ„ç®€åŒ–**
   - åˆ é™¤4ä¸ªè¡¨ï¼ˆroles, permissions, user_roles, role_permissionsï¼‰
   - ä»£ç é‡å‡å°‘60%
   - ç»´æŠ¤æˆæœ¬å¤§å¹…é™ä½

2. **æ€§èƒ½æå‡**
   - æƒé™æ£€æŸ¥é€Ÿåº¦æå‡95%
   - æ•°æ®åº“æŸ¥è¯¢å‡å°‘80%
   - APIå“åº”æ›´å¿«

3. **æ˜“äºç†è§£**
   - æ™®é€šç”¨æˆ· = 7ä¸ªæƒé™
   - VIPç”¨æˆ· = 13ä¸ªæƒé™
   - ç®¡ç†å‘˜ = æ‰€æœ‰æƒé™
   - ä¸€ç›®äº†ç„¶

4. **æ‰©å±•æ€§å¥½**
   - æ–°å¢æƒé™åªéœ€ä¿®æ”¹permissions.py
   - æ”¯æŒé€šé…ç¬¦æƒé™
   - æ”¯æŒæƒé™ç»§æ‰¿

### ğŸ“‹ æ£€æŸ¥æ¸…å•

- [ ] æ•°æ®åº“å·²å¤‡ä»½
- [ ] è¿ç§»è„šæœ¬å·²æµ‹è¯•
- [ ] åç«¯ä»£ç å·²é‡æ„
- [ ] å‰ç«¯ä»£ç å·²æ›´æ–°
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] æ–‡æ¡£å·²æ›´æ–°
- [ ] éƒ¨ç½²è®¡åˆ’å·²åˆ¶å®š
- [ ] å›æ»šæ–¹æ¡ˆå·²å‡†å¤‡

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¶é—´**: 2024å¹´1æœˆ
**é¢„è®¡å·¥æ—¶**: 8-10å¤©
**é£é™©ç­‰çº§**: ä¸­ç­‰ï¼ˆæœ‰å®Œæ•´çš„å›æ»šæ–¹æ¡ˆï¼‰
**å»ºè®®**: å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ï¼Œç¡®è®¤æ— è¯¯åå†éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒ

---

## é™„å½•ï¼šå®Œæ•´æ–‡ä»¶æ¸…å•

### éœ€è¦åˆ›å»ºçš„æ–‡ä»¶
1. `video-api/app/core/permissions.py` - æƒé™é…ç½®
2. `video-api/scripts/init_db.py` - æ•°æ®åº“åˆå§‹åŒ–
3. `video-api/scripts/migrate_roles.py` - è§’è‰²è¿ç§»è„šæœ¬

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶
1. `video-api/app/core/deps.py` - ä¾èµ–å‡½æ•°
2. `video-api/app/models/user.py` - ç”¨æˆ·æ¨¡å‹
3. `video-api/app/api/shares.py` - åˆ†äº«API
4. `video-api/app/api/admin_users.py` - ç”¨æˆ·ç®¡ç†API
5. `video-api/admin-frontend/src/stores/user.ts` - ç”¨æˆ·Store
6. `video-api/admin-frontend/src/api/index.ts` - APIç±»å‹

### éœ€è¦åˆ é™¤çš„æ–‡ä»¶
1. `video-api/app/api/admin_roles.py` - è§’è‰²ç®¡ç†APIï¼ˆä¸å†éœ€è¦ï¼‰
2. `video-api/admin-frontend/src/views/Roles.vue` - è§’è‰²ç®¡ç†é¡µé¢ï¼ˆä¸å†éœ€è¦ï¼‰

---

**ğŸ‰ é‡æ„æ–¹æ¡ˆæ–‡æ¡£å®Œæˆï¼**


